import React, { useState, useEffect } from 'react';
import { ShoppingCart, Home, Search, Bell, User, Plus, Minus, Star, Heart, ChevronLeft, Settings, X, Trash2, Moon, Sun, Navigation, Truck, Clock, CheckCircle, Edit, MapPin, Package, MessageCircle, Share } from 'lucide-react';

const HalalStoreApp = () => {
  const [currentPage, setCurrentPage] = useState('home');
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [quantity, setQuantity] = useState(1);
  const [cart, setCart] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [activeCategory, setActiveCategory] = useState('all');
  const [isAdmin, setIsAdmin] = useState(false);
  const [showAdminLogin, setShowAdminLogin] = useState(false);
  const [adminPassword, setAdminPassword] = useState('');
  const [adminEmail, setAdminEmail] = useState('');
  const [darkMode, setDarkMode] = useState(false);
  const [language, setLanguage] = useState('en');
  const [showSettings, setShowSettings] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [isUserLoggedIn, setIsUserLoggedIn] = useState(false);
  const [userEmail, setUserEmail] = useState('');
  const [userPassword, setUserPassword] = useState('');
  const [userName, setUserName] = useState('');
  const [showUserLogin, setShowUserLogin] = useState(false);
  const [orders, setOrders] = useState([]);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [userLocation, setUserLocation] = useState(null);
  const [locationEnabled, setLocationEnabled] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [viewingOrder, setViewingOrder] = useState(null);
  const [confirmingDelivery, setConfirmingDelivery] = useState(null);
  const [deliveryCode, setDeliveryCode] = useState('');

  const [currentSlide, setCurrentSlide] = useState(0);
  const [isPaused, setIsPaused] = useState(false);
  const [editingSlide, setEditingSlide] = useState(null);
  const [newSlide, setNewSlide] = useState({
    title: '',
    subtitle: '',
    description: '',
    image: '',
    cta: 'Shop Now',
    discount: ''
  });

  // New features state
  const [notifications, setNotifications] = useState([]);
  const [showNotifications, setShowNotifications] = useState(false);
  const [chatOpen, setChatOpen] = useState(false);
  const [chatMessages, setChatMessages] = useState([
    { id: 1, sender: 'support', text: 'Hello! How can I help you today?', time: '10:30 AM' }
  ]);
  const [chatInput, setChatInput] = useState('');
  const [couponCode, setCouponCode] = useState('');
  const [appliedCoupon, setAppliedCoupon] = useState(null);
  const [coupons] = useState([
    { code: 'SAVE20', discount: 20, type: 'percent' },
    { code: 'HALAL10', discount: 10, type: 'fixed' }
  ]);
  const [showStats, setShowStats] = useState(false);
  const [searchFilters, setSearchFilters] = useState({
    minPrice: '',
    maxPrice: '',
    rating: 0,
    sortBy: 'none'
  });
  const [showFilters, setShowFilters] = useState(false);
  const [driverLocation, setDriverLocation] = useState(null);
  const [showMap, setShowMap] = useState(false);

  const [slides, setSlides] = useState([
    {
      id: 1,
      title: 'Fresh Halal Meats',
      subtitle: 'Premium Quality for Your Family',
      description: 'Discover our selection of certified halal products',
      image: 'https://images.unsplash.com/photo-1588168333986-5078d3ae3976?w=1200&h=500&fit=crop',
      cta: 'Shop Now',
      discount: '30% OFF'
    },
    {
      id: 2,
      title: 'Best Prices Guaranteed',
      subtitle: 'Save More Every Day',
      description: 'Special offers on all products',
      image: 'https://images.unsplash.com/photo-1603048588665-791ca8aea617?w=1200&h=500&fit=crop',
      cta: 'View Deals',
      discount: '25% OFF'
    },
    {
      id: 3,
      title: 'Fast Delivery',
      subtitle: 'Get Your Order in 30 Minutes',
      description: 'Free delivery on orders over $50',
      image: 'https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=1200&h=500&fit=crop',
      cta: 'Order Now',
      discount: 'FREE SHIPPING'
    }
  ]);

  useEffect(() => {
    if (!isPaused && slides && slides.length > 0) {
      const timer = setInterval(() => {
        setCurrentSlide((prev) => (prev + 1) % slides.length);
      }, 5000);
      return () => clearInterval(timer);
    }
  }, [isPaused, slides]);

  const nextSlide = () => {
    if (slides && slides.length > 0) {
      setCurrentSlide((prev) => (prev + 1) % slides.length);
    }
  };

  const prevSlide = () => {
    if (slides && slides.length > 0) {
      setCurrentSlide((prev) => (prev - 1 + slides.length) % slides.length);
    }
  };

  const [newProduct, setNewProduct] = useState({
    name: '',
    price: '',
    oldPrice: '',
    category: 'beef',
    image: '',
    badge: ''
  });

  const handleSlideImageUpload = (e, isEditing = false) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
      alert('âŒ Please select an image file!');
      return;
    }

    const reader = new FileReader();
    reader.onloadend = () => {
      const result = reader.result;
      if (isEditing && editingSlide) {
        setEditingSlide({...editingSlide, image: result});
      } else {
        setNewSlide({...newSlide, image: result});
      }
    };
    reader.onerror = () => {
      alert('âŒ Error reading file!');
    };
    reader.readAsDataURL(file);
  };

  const handleAddSlide = () => {
    if (!newSlide.title || !newSlide.image) {
      alert('Please fill Title and Image!');
      return;
    }

    const slide = {
      id: Date.now(),
      title: newSlide.title,
      subtitle: newSlide.subtitle,
      description: newSlide.description,
      image: newSlide.image,
      cta: newSlide.cta || 'Shop Now',
      discount: newSlide.discount
    };

    setSlides([...slides, slide]);
    setNewSlide({
      title: '',
      subtitle: '',
      description: '',
      image: '',
      cta: 'Shop Now',
      discount: ''
    });
    alert('âœ… Slide added successfully!');
  };

  const handleUpdateSlide = () => {
    if (!editingSlide) return;
    
    setSlides(slides.map(s => 
      s.id === editingSlide.id ? editingSlide : s
    ));
    setEditingSlide(null);
    alert('âœ… Slide updated!');
  };

  const handleDeleteSlide = (id) => {
    if (slides.length <= 1) {
      alert('Cannot delete the last slide!');
      return;
    }
    if (window.confirm('Delete this slide?')) {
      setSlides(slides.filter(s => s.id !== id));
      alert('âœ… Slide deleted!');
    }
  };

  const handleProductImageUpload = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
      alert('âŒ Please select an image file!');
      return;
    }

    const reader = new FileReader();
    reader.onloadend = () => {
      setNewProduct({...newProduct, image: reader.result});
    };
    reader.onerror = () => {
      alert('âŒ Error reading file!');
    };
    reader.readAsDataURL(file);
  };

  const handleWhatsAppContact = () => {
    window.open('https://wa.me/573215874058', '_blank');
  };

  const handleGmailRegister = () => {
    handleGmailLogin();
  };
  
  const translations = {
    en: { halalStore: 'Halal Store', home: 'Home', cart: 'Cart', alerts: 'Alerts', profile: 'Profile', settings: 'Settings', language: 'Language', darkMode: 'Dark Mode', enableLocation: 'Enable GPS', locationEnabled: 'GPS Active', adminLogin: 'Admin Login', userLogin: 'User Login', register: 'Register', login: 'Login', logout: 'Logout', welcome: 'Welcome', myOrders: 'My Orders', myProfile: 'My Profile', search: 'Search products...', noResults: 'No products found', email: 'Email', password: 'Password', categories: 'Categories', all: 'All', beef: 'Beef', chicken: 'Chicken', lamb: 'Lamb', addToCart: 'Add to Cart', total: 'Total', quantity: 'Quantity', checkout: 'Checkout', preparing: 'Preparing', outForDelivery: 'Out for Delivery', delivered: 'Delivered', trackOrder: 'Track Order', orderPlaced: 'Order Placed!', estimatedTime: 'Est. Time', wrongCredentials: 'Wrong email or password!', orderNumber: 'Order #', inProgress: 'In progress...', completed: 'Completed', driverOnWay: 'Driver on the way...', waiting: 'Waiting...', locationPermission: 'Location permission granted', locationDenied: 'Location permission denied', contact: 'Contact', chat: 'Live Chat', sendMessage: 'Send message...', applyCoupon: 'Apply Coupon', couponApplied: 'Coupon Applied!', invalidCoupon: 'Invalid coupon', statistics: 'Statistics', filters: 'Filters', minPrice: 'Min Price', maxPrice: 'Max Price', sortBy: 'Sort By', rateProduct: 'Rate Product', share: 'Share', trackDriver: 'Track Driver', notifications: 'Notifications', newOrder: 'New Order Received!', orderAccepted: 'Order Accepted', orderDelivered: 'Order Delivered', discount: 'Discount', savings: 'You Save' },
    es: { halalStore: 'Tienda Halal', home: 'Inicio', cart: 'Carrito', alerts: 'Alertas', profile: 'Perfil', settings: 'Ajustes', language: 'Idioma', darkMode: 'Modo Oscuro', enableLocation: 'Activar GPS', locationEnabled: 'GPS Activo', adminLogin: 'Admin', userLogin: 'Iniciar SesiÃ³n', register: 'Registrarse', login: 'Entrar', logout: 'Salir', welcome: 'Bienvenido', myOrders: 'Mis Pedidos', myProfile: 'Mi Perfil', search: 'Buscar productos...', noResults: 'No se encontraron productos', email: 'Correo', password: 'ContraseÃ±a', categories: 'CategorÃ­as', all: 'Todo', beef: 'Res', chicken: 'Pollo', lamb: 'Cordero', addToCart: 'AÃ±adir', total: 'Total', quantity: 'Cantidad', checkout: 'Pagar', preparing: 'Preparando', outForDelivery: 'En Camino', delivered: 'Entregado', trackOrder: 'Rastrear', orderPlaced: 'Â¡Pedido Realizado!', estimatedTime: 'Tiempo Est.', wrongCredentials: 'Â¡Correo o contraseÃ±a incorrectos!', orderNumber: 'Pedido #', inProgress: 'En progreso...', completed: 'Completado', driverOnWay: 'Conductor en camino...', waiting: 'Esperando...', locationPermission: 'Permiso de ubicaciÃ³n concedido', locationDenied: 'Permiso de ubicaciÃ³n denegado', contact: 'Contacto', chat: 'Chat en Vivo', sendMessage: 'Enviar mensaje...', applyCoupon: 'Aplicar CupÃ³n', couponApplied: 'Â¡CupÃ³n Aplicado!', invalidCoupon: 'CupÃ³n invÃ¡lido', statistics: 'EstadÃ­sticas', filters: 'Filtros', minPrice: 'Precio MÃ­n', maxPrice: 'Precio MÃ¡x', sortBy: 'Ordenar Por', rateProduct: 'Calificar', share: 'Compartir', trackDriver: 'Rastrear Conductor', notifications: 'Notificaciones', newOrder: 'Â¡Nuevo Pedido!', orderAccepted: 'Pedido Aceptado', orderDelivered: 'Pedido Entregado', discount: 'Descuento', savings: 'Ahorras' },
    ar: { halalStore: 'Ù…ØªØ¬Ø± Ø­Ù„Ø§Ù„', home: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', cart: 'Ø§Ù„Ø³Ù„Ø©', alerts: 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', profile: 'Ø§Ù„Ù…Ù„Ù', settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', language: 'Ø§Ù„Ù„ØºØ©', darkMode: 'ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ', enableLocation: 'ØªÙØ¹ÙŠÙ„ GPS', locationEnabled: 'GPS Ù†Ø´Ø·', adminLogin: 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„', userLogin: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', register: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨', login: 'Ø¯Ø®ÙˆÙ„', logout: 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬', welcome: 'Ù…Ø±Ø­Ø¨Ø§Ù‹', myOrders: 'Ø·Ù„Ø¨Ø§ØªÙŠ', myProfile: 'Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ', search: 'Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...', noResults: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª', email: 'Ø§Ù„Ø¨Ø±ÙŠØ¯', password: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', categories: 'Ø§Ù„ÙØ¦Ø§Øª', all: 'Ø§Ù„ÙƒÙ„', beef: 'Ù„Ø­Ù… Ø¨Ù‚Ø±', chicken: 'Ø¯Ø¬Ø§Ø¬', lamb: 'Ø®Ø±ÙˆÙ', addToCart: 'Ø£Ø¶Ù', total: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', quantity: 'Ø§Ù„ÙƒÙ…ÙŠØ©', checkout: 'Ø¥ØªÙ…Ø§Ù…', preparing: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±', outForDelivery: 'Ø®Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„', delivered: 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', trackOrder: 'ØªØªØ¨Ø¹', orderPlaced: 'ØªÙ… Ø§Ù„Ø·Ù„Ø¨!', estimatedTime: 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹', wrongCredentials: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!', orderNumber: 'Ø·Ù„Ø¨ #', inProgress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°...', completed: 'Ù…ÙƒØªÙ…Ù„', driverOnWay: 'Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚...', waiting: 'Ø§Ù†ØªØ¸Ø§Ø±...', locationPermission: 'ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹', locationDenied: 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹', contact: 'Ø§ØªØµÙ„ Ø¨Ù†Ø§', chat: 'Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø©', sendMessage: 'Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø©...', applyCoupon: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø³ÙŠÙ…Ø©', couponApplied: 'ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø³ÙŠÙ…Ø©!', invalidCoupon: 'Ù‚Ø³ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©', statistics: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', filters: 'ÙÙ„Ø§ØªØ±', minPrice: 'Ø£Ù‚Ù„ Ø³Ø¹Ø±', maxPrice: 'Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±', sortBy: 'ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨', rateProduct: 'ØªÙ‚ÙŠÙŠÙ…', share: 'Ù…Ø´Ø§Ø±ÙƒØ©', trackDriver: 'ØªØªØ¨Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚', notifications: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', newOrder: 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!', orderAccepted: 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', orderDelivered: 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', discount: 'Ø®ØµÙ…', savings: 'ØªÙˆÙØ±' }
  };
  const t = translations[language];

  const [products, setProducts] = useState([
    {
      id: 1,
      name: 'Best Beef Steak',
      price: 150,
      oldPrice: 200,
      rating: 4.6,
      image: 'https://images.unsplash.com/photo-1588168333986-5078d3ae3976?w=500&h=400&fit=crop',
      category: 'beef',
      badge: 'BEST'
    },
    {
      id: 2,
      name: 'Chicken Premium',
      price: 170,
      oldPrice: 220,
      rating: 4.5,
      image: 'https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=500&h=400&fit=crop',
      category: 'chicken',
      badge: 'NEW'
    },
    {
      id: 3,
      name: 'Lamb Chops',
      price: 280,
      oldPrice: 320,
      rating: 4.8,
      image: 'https://images.unsplash.com/photo-1603048588665-791ca8aea617?w=500&h=400&fit=crop',
      category: 'lamb',
      badge: 'PREMIUM'
    },
    {
      id: 4,
      name: 'Angus Beef',
      price: 220,
      oldPrice: 280,
      rating: 4.7,
      image: 'https://images.unsplash.com/photo-1603048588665-791ca8aea617?w=500&h=400&fit=crop',
      category: 'beef',
      badge: 'PREMIUM'
    },
    {
      id: 5,
      name: 'Organic Chicken',
      price: 145,
      rating: 4.4,
      image: 'https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=500&h=400&fit=crop',
      category: 'chicken',
      badge: ''
    }
  ]);

  const categories = [
    { id: 'all', name: t.all, icon: 'ðŸ›’' },
    { id: 'beef', name: t.beef, icon: 'ðŸ¥©' },
    { id: 'chicken', name: t.chicken, icon: 'ðŸ—' },
    { id: 'lamb', name: t.lamb, icon: 'ðŸ‘' }
  ];

  const requestLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setUserLocation({
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
          setLocationEnabled(true);
          alert(t.locationPermission);
        },
        (error) => {
          setLocationEnabled(false);
          alert(t.locationDenied);
        }
      );
    } else {
      alert('GPS not supported');
    }
  };

  const addNotification = (title, message) => {
    const newNotif = {
      id: Date.now(),
      title,
      message,
      time: new Date().toLocaleTimeString(),
      read: false
    };
    setNotifications([newNotif, ...notifications]);
  };

  const handleSendMessage = () => {
    if (!chatInput.trim()) return;
    const newMsg = {
      id: Date.now(),
      sender: 'user',
      text: chatInput,
      time: new Date().toLocaleTimeString()
    };
    setChatMessages([...chatMessages, newMsg]);
    setChatInput('');
    
    setTimeout(() => {
      const response = {
        id: Date.now() + 1,
        sender: 'support',
        text: 'Thank you for your message! How else can I help you?',
        time: new Date().toLocaleTimeString()
      };
      setChatMessages(prev => [...prev, response]);
    }, 1000);
  };

  const handleApplyCoupon = () => {
    const coupon = coupons.find(c => c.code.toUpperCase() === couponCode.toUpperCase());
    if (coupon) {
      setAppliedCoupon(coupon);
      alert('âœ… ' + t.couponApplied + ' ' + coupon.discount + (coupon.type === 'percent' ? '%' : ' CAD'));
    } else {
      alert('âŒ ' + t.invalidCoupon);
    }
  };

  const handleShareProduct = (product) => {
    if (navigator.share) {
      navigator.share({
        title: product.name,
        text: `Check out ${product.name} for ${product.price} CAD!`,
        url: window.location.href
      });
    } else {
      alert('Share: ' + product.name);
    }
  };

  const applyFilters = (productsList) => {
    let filtered = [...productsList];
    
    if (searchFilters.minPrice) {
      filtered = filtered.filter(p => p.price >= parseFloat(searchFilters.minPrice));
    }
    if (searchFilters.maxPrice) {
      filtered = filtered.filter(p => p.price <= parseFloat(searchFilters.maxPrice));
    }
    if (searchFilters.rating > 0) {
      filtered = filtered.filter(p => p.rating >= searchFilters.rating);
    }
    
    if (searchFilters.sortBy === 'priceLow') {
      filtered.sort((a, b) => a.price - b.price);
    } else if (searchFilters.sortBy === 'priceHigh') {
      filtered.sort((a, b) => b.price - a.price);
    } else if (searchFilters.sortBy === 'rating') {
      filtered.sort((a, b) => b.rating - a.rating);
    }
    
    return filtered;
  };

  const filteredProducts = activeCategory === 'all' ? products : products.filter(p => p.category === activeCategory);

  const searchedProducts = searchQuery.trim() === '' 
    ? applyFilters(filteredProducts)
    : applyFilters(filteredProducts.filter(p => 
        p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        p.category.toLowerCase().includes(searchQuery.toLowerCase())
      ));

  const handleUserLogin = () => {
    if (userEmail.trim() && userPassword.trim()) {
      setIsUserLoggedIn(true);
      setUserName(userEmail.split('@')[0]);
      setShowUserLogin(false);
      setUserEmail('');
      setUserPassword('');
      setCurrentPage('profile');
      alert('âœ… Welcome back!');
    } else {
      alert('âŒ Please enter email and password!');
    }
  };

  const handleGmailLogin = () => {
    const popup = window.open(
      'https://accounts.google.com/o/oauth2/v2/auth?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&response_type=token&scope=email%20profile',
      'Gmail Login',
      'width=500,height=600'
    );
    
    setTimeout(() => {
      if (popup) popup.close();
      const mockGmailUser = 'user' + Math.floor(Math.random() * 1000) + '@gmail.com';
      setIsUserLoggedIn(true);
      setUserName(mockGmailUser);
      setUserEmail(mockGmailUser);
      setShowUserLogin(false);
      setCurrentPage('profile');
      alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± Gmail!');
    }, 2000);
  };

  const handleUserLogout = () => {
    setIsUserLoggedIn(false);
    setUserName('');
    setCurrentPage('home');
    alert('ðŸ‘‹ Logged out successfully!');
  };

  const addToCart = (product, qty) => {
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
      setCart(cart.map(item => item.id === product.id ? { ...item, quantity: item.quantity + qty } : item));
    } else {
      setCart([...cart, { ...product, quantity: qty }]);
    }
  };

  const handleCheckout = () => {
    const code = Math.floor(1000 + Math.random() * 9000);
    const discount = appliedCoupon ? (appliedCoupon.type === 'percent' ? cartTotal * appliedCoupon.discount / 100 : appliedCoupon.discount) : 0;
    const subtotal = cartTotal - discount;
    const newOrder = {
      id: Date.now(),
      items: [...cart],
      subtotal: cartTotal.toFixed(2),
      discount: discount.toFixed(2),
      total: (subtotal + 10 + subtotal * 0.13).toFixed(2),
      status: 'preparing',
      estimatedTime: '30-45 min',
      timestamp: Date.now(),
      customerName: userName || 'Customer #' + Math.floor(Math.random() * 1000),
      accepted: false,
      deliveryCode: code,
      paymentMethod: 'nequi',
      nequiNumber: '+57 321 5874058',
      couponUsed: appliedCoupon ? appliedCoupon.code : null
    };
    setOrders([newOrder, ...orders]);
    setCart([]);
    setAppliedCoupon(null);
    setCouponCode('');
    setSelectedOrder(newOrder);
    setCurrentPage('tracking');
    
    if (isAdmin) {
      addNotification('New Order #' + newOrder.id, 'A new order has been placed!');
    }
  };

  const handleAcceptOrder = (orderId) => {
    setOrders(orders.map(o => 
      o.id === orderId ? { ...o, accepted: true, status: 'preparing' } : o
    ));
    addNotification(t.orderAccepted, 'Order #' + orderId + ' accepted');
    alert('âœ… Order accepted!');
  };

  const handleMarkAsDelivery = (orderId) => {
    setO
